var firestoreQueryParser=function(){var o=function(k,v,o,l){for(o=o||{},l=k.length;l--;o[k[l]]=v);return o},$V0=[1,6],$V1=[1,8],$V2=[1,9],$V3=[1,10],$V4=[1,14],$V5=[8,19,22],$V6=[1,44],$V7=[1,43],$V8=[1,42],$V9=[1,45],$Va=[1,46],$Vb=[11,23,48,49,50],$Vc=[1,52],$Vd=[8,19,22,44],$Ve=[8,12,19,22,44,47],$Vf=[8,22],$Vg=[8,12,22];var parser={trace:function trace(){},yy:{},symbols_:{error:2,expressions:3,fromExpr:4,WHERE:5,boolExpr:6,orderLimit:7,EOF:8,FROM:9,fromVals:10,STRING:11,",":12,fromType:13,DOC:14,COLLECTION:15,COLGROUP:16,compExpr:17,boolOp:18,ORDER:19,BY:20,orderExpr:21,LIMIT:22,INT:23,orderItem:24,IDENTIFIER:25,orderType:26,ASC:27,DESC:28,name:29,compOp:30,literal:31,arrayOp:32,array:33,"<":34,"<=":35,"==":36,">=":37,">":38,"!=":39,"array-contains":40,"array-contains-any":41,in:42,"not-in":43,and:44,"[":45,arrayItems:46,"]":47,FLOAT:48,BOOL:49,VAR:50,$accept:0,$end:1},terminals_:{2:"error",5:"WHERE",8:"EOF",9:"FROM",11:"STRING",12:",",14:"DOC",15:"COLLECTION",16:"COLGROUP",19:"ORDER",20:"BY",22:"LIMIT",23:"INT",25:"IDENTIFIER",27:"ASC",28:"DESC",34:"<",35:"<=",36:"==",37:">=",38:">",39:"!=",40:"array-contains",41:"array-contains-any",42:"in",43:"not-in",44:"and",45:"[",47:"]",48:"FLOAT",49:"BOOL",50:"VAR"},productions_:[0,[3,5],[3,4],[4,2],[10,3],[10,4],[10,1],[10,2],[13,1],[13,1],[13,1],[6,3],[6,1],[7,5],[7,3],[7,2],[21,3],[21,1],[24,2],[24,1],[26,1],[26,1],[17,3],[17,3],[30,1],[30,1],[30,1],[30,1],[30,1],[30,1],[32,1],[32,1],[32,1],[32,1],[18,1],[33,3],[33,2],[46,3],[46,1],[31,1],[31,1],[31,1],[31,1],[31,1],[29,1]],performAction:function anonymous(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return{from:$$[$0-4],where:$$[$0-2],order:$$[$0-1].order,limit:$$[$0-1].limit};break;case 2:return{from:$$[$0-3],where:$$[$0-1],order:[],limit:null};break;case 3:this.$=$$[$0];break;case 4:this.$=[{type:"COLLECTION",v:JSON.parse($$[$0-2])}].concat($$[$0]);break;case 5:this.$=[{type:$$[$0-3],v:JSON.parse($$[$0-2])}].concat($$[$0]);break;case 6:this.$=[{type:"COLLECTION",v:JSON.parse($$[$0])}];break;case 7:this.$=[{type:$$[$0-1],v:JSON.parse($$[$0])}];break;case 8:case 9:case 10:case 20:case 21:this.$=yytext;break;case 11:this.$={type:"boolExpr",left:$$[$0-2],op:$$[$0-1],right:$$[$0]};break;case 12:this.$=$$[$0];break;case 13:this.$={type:"orderLimit",order:$$[$0-2],limit:parseInt($$[$0],10)};break;case 14:this.$={type:"orderLimit",order:$$[$0],limit:null};break;case 15:this.$={type:"orderLimit",order:[],limit:parseInt($$[$0],10)};break;case 16:case 37:this.$=[$$[$0-2]].concat($$[$0]);break;case 17:case 38:this.$=[$$[$0]];break;case 18:this.$={type:"orderItem",v:$$[$0-1],type:$$[$0]};break;case 19:this.$={type:"orderItem",v:$$[$0],type:"ASC"};break;case 22:case 23:this.$={type:"compExpr",left:$$[$0-2],op:$$[$0-1],right:$$[$0]};break;case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 32:case 33:this.$={type:"compOp",v:yytext};break;case 34:this.$={type:"boolOp",v:yytext};break;case 35:this.$={type:"array",v:$$[$0-1]};break;case 36:this.$={type:"array",v:[]};break;case 39:this.$={type:"float",v:parseFloat(yytext)};break;case 40:this.$={type:"int",v:parseInt(yytext,10)};break;case 41:this.$={type:"str",v:JSON.parse(yytext)};break;case 42:this.$={type:"bool",v:yytext==="true"};break;case 43:this.$={type:"var",v:yytext.slice(2,-1)};break;case 44:this.$={type:"name",v:yytext};break}},table:[{3:1,4:2,9:[1,3]},{1:[3]},{5:[1,4]},{10:5,11:$V0,13:7,14:$V1,15:$V2,16:$V3},{6:11,17:12,25:$V4,29:13},{5:[2,3]},{5:[2,6],12:[1,15]},{11:[1,16]},{11:[2,8]},{11:[2,9]},{11:[2,10]},{7:17,8:[1,18],19:[1,19],22:[1,20]},o($V5,[2,12],{18:21,44:[1,22]}),{30:23,32:24,34:[1,25],35:[1,26],36:[1,27],37:[1,28],38:[1,29],39:[1,30],40:[1,31],41:[1,32],42:[1,33],43:[1,34]},o([34,35,36,37,38,39,40,41,42,43],[2,44]),{10:35,11:$V0,13:7,14:$V1,15:$V2,16:$V3},{5:[2,7],12:[1,36]},{8:[1,37]},{1:[2,2]},{20:[1,38]},{23:[1,39]},{6:40,17:12,25:$V4,29:13},{25:[2,34]},{11:$V6,23:$V7,31:41,48:$V8,49:$V9,50:$Va},{33:47,45:[1,48]},o($Vb,[2,24]),o($Vb,[2,25]),o($Vb,[2,26]),o($Vb,[2,27]),o($Vb,[2,28]),o($Vb,[2,29]),{45:[2,30]},{45:[2,31]},{45:[2,32]},{45:[2,33]},{5:[2,4]},{10:49,11:$V0,13:7,14:$V1,15:$V2,16:$V3},{1:[2,1]},{21:50,24:51,25:$Vc},{8:[2,15]},o($V5,[2,11]),o($Vd,[2,22]),o($Ve,[2,39]),o($Ve,[2,40]),o($Ve,[2,41]),o($Ve,[2,42]),o($Ve,[2,43]),o($Vd,[2,23]),{11:$V6,23:$V7,31:55,46:53,47:[1,54],48:$V8,49:$V9,50:$Va},{5:[2,5]},{8:[2,14],22:[1,56]},o($Vf,[2,17],{12:[1,57]}),o($Vg,[2,19],{26:58,27:[1,59],28:[1,60]}),{47:[1,61]},o($Vd,[2,36]),{12:[1,62],47:[2,38]},{23:[1,63]},{21:64,24:51,25:$Vc},o($Vg,[2,18]),o($Vg,[2,20]),o($Vg,[2,21]),o($Vd,[2,35]),{11:$V6,23:$V7,31:55,46:65,48:$V8,49:$V9,50:$Va},{8:[2,13]},o($Vf,[2,16]),{47:[2,37]}],defaultActions:{5:[2,3],8:[2,8],9:[2,9],10:[2,10],18:[2,2],22:[2,34],31:[2,30],32:[2,31],33:[2,32],34:[2,33],35:[2,4],37:[2,1],39:[2,15],49:[2,5],63:[2,13],65:[2,37]},parseError:function parseError(str,hash){if(hash.recoverable){this.trace(str)}else{var error=new Error(str);error.hash=hash;throw error}},parse:function parse(input){var self=this,stack=[0],tstack=[],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,recovering=0,TERROR=2,EOF=1;var args=lstack.slice.call(arguments,1);var lexer=Object.create(this.lexer);var sharedState={yy:{}};for(var k in this.yy){if(Object.prototype.hasOwnProperty.call(this.yy,k)){sharedState.yy[k]=this.yy[k]}}lexer.setInput(input,sharedState.yy);sharedState.yy.lexer=lexer;sharedState.yy.parser=this;if(typeof lexer.yylloc=="undefined"){lexer.yylloc={}}var yyloc=lexer.yylloc;lstack.push(yyloc);var ranges=lexer.options&&lexer.options.ranges;if(typeof sharedState.yy.parseError==="function"){this.parseError=sharedState.yy.parseError}else{this.parseError=Object.getPrototypeOf(this).parseError}function popStack(n){stack.length=stack.length-2*n;vstack.length=vstack.length-n;lstack.length=lstack.length-n}_token_stack:var lex=function(){var token;token=lexer.lex()||EOF;if(typeof token!=="number"){token=self.symbols_[token]||token}return token};var symbol,preErrorSymbol,state,action,a,r,yyval={},p,len,newState,expected;while(true){state=stack[stack.length-1];if(this.defaultActions[state]){action=this.defaultActions[state]}else{if(symbol===null||typeof symbol=="undefined"){symbol=lex()}action=table[state]&&table[state][symbol]}if(typeof action==="undefined"||!action.length||!action[0]){var errStr="";expected=[];for(p in table[state]){if(this.terminals_[p]&&p>TERROR){expected.push("'"+this.terminals_[p]+"'")}}if(lexer.showPosition){errStr="Parse error on line "+(yylineno+1)+":\n"+lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'"}else{errStr="Parse error on line "+(yylineno+1)+": Unexpected "+(symbol==EOF?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'")}this.parseError(errStr,{text:lexer.match,token:this.terminals_[symbol]||symbol,line:lexer.yylineno,loc:yyloc,expected:expected})}if(action[0]instanceof Array&&action.length>1){throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol)}switch(action[0]){case 1:stack.push(symbol);vstack.push(lexer.yytext);lstack.push(lexer.yylloc);stack.push(action[1]);symbol=null;if(!preErrorSymbol){yyleng=lexer.yyleng;yytext=lexer.yytext;yylineno=lexer.yylineno;yyloc=lexer.yylloc;if(recovering>0){recovering--}}else{symbol=preErrorSymbol;preErrorSymbol=null}break;case 2:len=this.productions_[action[1]][1];yyval.$=vstack[vstack.length-len];yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column};if(ranges){yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]}r=this.performAction.apply(yyval,[yytext,yyleng,yylineno,sharedState.yy,action[1],vstack,lstack].concat(args));if(typeof r!=="undefined"){return r}if(len){stack=stack.slice(0,-1*len*2);vstack=vstack.slice(0,-1*len);lstack=lstack.slice(0,-1*len)}stack.push(this.productions_[action[1]][0]);vstack.push(yyval.$);lstack.push(yyval._$);newState=table[stack[stack.length-2]][stack[stack.length-1]];stack.push(newState);break;case 3:return true}}return true}};var lexer=function(){var lexer={EOF:1,parseError:function parseError(str,hash){if(this.yy.parser){this.yy.parser.parseError(str,hash)}else{throw new Error(str)}},setInput:function(input,yy){this.yy=yy||this.yy||{};this._input=input;this._more=this._backtrack=this.done=false;this.yylineno=this.yyleng=0;this.yytext=this.matched=this.match="";this.conditionStack=["INITIAL"];this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0};if(this.options.ranges){this.yylloc.range=[0,0]}this.offset=0;return this},input:function(){var ch=this._input[0];this.yytext+=ch;this.yyleng++;this.offset++;this.match+=ch;this.matched+=ch;var lines=ch.match(/(?:\r\n?|\n).*/g);if(lines){this.yylineno++;this.yylloc.last_line++}else{this.yylloc.last_column++}if(this.options.ranges){this.yylloc.range[1]++}this._input=this._input.slice(1);return ch},unput:function(ch){var len=ch.length;var lines=ch.split(/(?:\r\n?|\n)/g);this._input=ch+this._input;this.yytext=this.yytext.substr(0,this.yytext.length-len);this.offset-=len;var oldLines=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1);this.matched=this.matched.substr(0,this.matched.length-1);if(lines.length-1){this.yylineno-=lines.length-1}var r=this.yylloc.range;this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:lines?(lines.length===oldLines.length?this.yylloc.first_column:0)+oldLines[oldLines.length-lines.length].length-lines[0].length:this.yylloc.first_column-len};if(this.options.ranges){this.yylloc.range=[r[0],r[0]+this.yyleng-len]}this.yyleng=this.yytext.length;return this},more:function(){this._more=true;return this},reject:function(){if(this.options.backtrack_lexer){this._backtrack=true}else{return this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})}return this},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;if(next.length<20){next+=this._input.substr(0,20-next.length)}return(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput();var c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},test_match:function(match,indexed_rule){var token,lines,backup;if(this.options.backtrack_lexer){backup={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done};if(this.options.ranges){backup.yylloc.range=this.yylloc.range.slice(0)}}lines=match[0].match(/(?:\r\n?|\n).*/g);if(lines){this.yylineno+=lines.length}this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+match[0].length};this.yytext+=match[0];this.match+=match[0];this.matches=match;this.yyleng=this.yytext.length;if(this.options.ranges){this.yylloc.range=[this.offset,this.offset+=this.yyleng]}this._more=false;this._backtrack=false;this._input=this._input.slice(match[0].length);this.matched+=match[0];token=this.performAction.call(this,this.yy,this,indexed_rule,this.conditionStack[this.conditionStack.length-1]);if(this.done&&this._input){this.done=false}if(token){return token}else if(this._backtrack){for(var k in backup){this[k]=backup[k]}return false}return false},next:function(){if(this.done){return this.EOF}if(!this._input){this.done=true}var token,match,tempMatch,index;if(!this._more){this.yytext="";this.match=""}var rules=this._currentRules();for(var i=0;i<rules.length;i++){tempMatch=this._input.match(this.rules[rules[i]]);if(tempMatch&&(!match||tempMatch[0].length>match[0].length)){match=tempMatch;index=i;if(this.options.backtrack_lexer){token=this.test_match(tempMatch,rules[i]);if(token!==false){return token}else if(this._backtrack){match=false;continue}else{return false}}else if(!this.options.flex){break}}}if(match){token=this.test_match(match,rules[index]);if(token!==false){return token}return false}if(this._input===""){return this.EOF}else{return this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})}},lex:function lex(){var r=this.next();if(r){return r}else{return this.lex()}},begin:function begin(condition){this.conditionStack.push(condition)},popState:function popState(){var n=this.conditionStack.length-1;if(n>0){return this.conditionStack.pop()}else{return this.conditionStack[0]}},_currentRules:function _currentRules(){if(this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules}else{return this.conditions["INITIAL"].rules}},topState:function topState(n){n=this.conditionStack.length-1-Math.abs(n||0);if(n>=0){return this.conditionStack[n]}else{return"INITIAL"}},pushState:function pushState(condition){this.begin(condition)},stateStackSize:function stateStackSize(){return this.conditionStack.length},options:{},performAction:function anonymous(yy,yy_,$avoiding_name_collisions,YY_START){var YYSTATE=YY_START;switch($avoiding_name_collisions){case 0:break;case 1:return 48;break;case 2:return 23;break;case 3:return 49;break;case 4:return 44;break;case 5:return 11;break;case 6:return 50;break;case 7:return 9;break;case 8:return 5;break;case 9:return 14;break;case 10:return 15;break;case 11:return 16;break;case 12:return 19;break;case 13:return 20;break;case 14:return 22;break;case 15:return 27;break;case 16:return 28;break;case 17:return 45;break;case 18:return 47;break;case 19:return 12;break;case 20:return 35;break;case 21:return 34;break;case 22:return 36;break;case 23:return 37;break;case 24:return 38;break;case 25:return 39;break;case 26:return 41;break;case 27:return 40;break;case 28:return 42;break;case 29:return 43;break;case 30:return 25;break;case 31:return 8;break;case 32:return"INVALID";break}},rules:[/^(?:\s+)/,/^(?:[0-9]+\.[0-9]+\b)/,/^(?:[0-9]+\b)/,/^(?:(true|false))/,/^(?:and\b)/,/^(?:"(\\["]|[^"])*")/,/^(?:\$\{[a-zA-Z0-9 ][a-zA-Z0-9_ ]*\})/,/^(?:FROM\b)/,/^(?:WHERE\b)/,/^(?:DOC\b)/,/^(?:COLLECTION\b)/,/^(?:COLGROUP\b)/,/^(?:ORDER\b)/,/^(?:BY\b)/,/^(?:LIMIT\b)/,/^(?:ASC\b)/,/^(?:DESC\b)/,/^(?:\[)/,/^(?:\])/,/^(?:,)/,/^(?:<=)/,/^(?:<)/,/^(?:==)/,/^(?:>=)/,/^(?:>)/,/^(?:!=)/,/^(?:array-contains-any\b)/,/^(?:array-contains\b)/,/^(?:in\b)/,/^(?:not-in\b)/,/^(?:[a-zA-Z]{1,}[a-zA-Z0-9_]*)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32],inclusive:true}}};return lexer}();parser.lexer=lexer;function Parser(){this.yy={}}Parser.prototype=parser;parser.Parser=Parser;return new Parser}();(function(){class Var{constructor(name){this.name=name}}function astToSExpr(ast){const root=fromToSExpr(ast.from);root.push(whereToSExpr(ast.where));if(ast.order.length>0){root.push(["orderBy",ast.order.map(({v,type})=>[v,type.toLowerCase()])])}if(ast.limit!==null){root.push(["limit",ast.limit])}return root}const FROM_TYPE_TO_NAME={COLLECTION:"collection",COLGROUP:"collectionGroup",DOC:"doc"};function fromToSExpr(items){return items.map(({type,v})=>[FROM_TYPE_TO_NAME[type],v])}function whereToSExpr(ast){const{type,v,left,op,right}=ast;switch(type){case"boolExpr":return["and",flattenAnds(right,[whereToSExpr(left)])];case"compExpr":return["where",[whereToSExpr(left),whereToSExpr(op),whereToSExpr(right)]];case"compOp":case"int":case"float":case"bool":case"str":case"name":return v;case"var":return new Var(v);case"array":return v.map(item=>whereToSExpr(item));default:console.warn("unknown node type",ast);return v}}function flattenAnds(ast,accum){if(ast.op.v==="and"){accum.push(whereToSExpr(ast.left));return flattenAnds(ast.right,accum)}else{accum.push(whereToSExpr(ast));return accum}}function astToPlan(ast){const items=astToSExpr(ast),plan=[];for(let expr of items){const[head,second]=expr;if(head==="and"){for(let where of second){plan.push(where)}}else if(head==="where"){plan.push(expr)}else if(head==="orderBy"){for(let order of second){plan.push(["orderBy",order])}}else if(!Array.isArray(second)){plan.push([head,[second]])}else{plan.push(expr)}}return plan}function applyToQuery(query,ast,vars,onVarNotFound){for(let[method,params]of astToPlan(ast)){query=query[method].apply(query,replaceParamVars(params,vars,onVarNotFound))}return query}function replaceParamVars(params,vars,onVarNotFound){return params.map(v=>{if(Array.isArray(v)){return replaceParamVars(v,vars,onVarNotFound)}else if(v instanceof Var){const value=vars[v.name];if(value===undefined){onVarNotFound(v,params);return null}else{return value}}else{return v}})}Object.assign(firestoreQueryParser,{astToSExpr:astToSExpr,astToPlan:astToPlan,applyToQuery:applyToQuery,Var:Var})})();